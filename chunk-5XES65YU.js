import{I as w,M as u,a as c,b as h,c as l,hb as p}from"./chunk-AEIAZLYF.js";var m=class f{authService=u(p);FOLDER_NAME_PREFIX="notes-app-data";FILE_NAME_PREFIX="notes-app-data";folderId=null;fileId=null;currentUserEmail=null;getFolderAndFileName(i){let t=i?i.replace(/[^a-zA-Z0-9]/g,"_"):"guest";return{folderName:`${this.FOLDER_NAME_PREFIX}-${t}`,fileName:`${this.FILE_NAME_PREFIX}-${t}.json`}}initializeFolderAndFile(i){return l(this,null,function*(){let t=this.authService.currentUser()?.email||null;this.currentUserEmail!==t&&(this.folderId=null,this.fileId=null,this.currentUserEmail=t),this.folderId||(this.folderId=yield this.findOrCreateFolder(i,t)),!this.fileId&&this.folderId&&(this.fileId=yield this.findOrCreateFile(i,t))})}findOrCreateFolder(i,t){return l(this,null,function*(){try{let{folderName:e}=this.getFolderAndFileName(t),o=yield(yield fetch(`https://www.googleapis.com/drive/v3/files?q=name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,{headers:{Authorization:`Bearer ${i}`}})).json();if(o.files&&o.files.length>0)return o.files[0].id;let r=yield fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({name:e,mimeType:"application/vnd.google-apps.folder"})});if(!r.ok)throw new Error("Failed to create folder in Google Drive");return(yield r.json()).id}catch(e){throw console.error("Error finding/creating folder:",e),e}})}findOrCreateFile(i,t){return l(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");try{let{fileName:e}=this.getFolderAndFileName(t),o=yield(yield fetch(`https://www.googleapis.com/drive/v3/files?q=name='${e}' and '${this.folderId}' in parents and trashed=false`,{headers:{Authorization:`Bearer ${i}`}})).json();return o.files&&o.files.length>0?o.files[0].id:null}catch(e){return console.error("Error finding file:",e),null}})}syncToDrive(i,t){return l(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let e=this.authService.getAccessToken();if(!e)throw new Error("No access token available");let n=i.some(r=>r.needsSync),o=t.some(r=>r.needsSync);if(!(!n&&!o))try{yield this.initializeFolderAndFile(e);let r=new Date,s={notes:i.map(g=>h(c({},g),{lastSyncedAt:r.toISOString(),needsSync:!1})),categories:t.map(g=>h(c({},g),{lastSyncedAt:r.toISOString(),needsSync:!1})),lastSynced:r.toISOString()},a=JSON.stringify(s,null,2),d=new Blob([a],{type:"application/json"});this.fileId?yield this.updateFile(this.fileId,d,e):this.fileId=yield this.createFile(d,e)}catch(r){throw r?.status===401||r?.code===401||r?.message&&r.message.includes("401")||r?.error&&r.error.code===401?(console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error syncing to Google Drive:",r),r)}})}syncFromDrive(i){return l(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let t=this.authService.getAccessToken();if(!t)throw new Error("No access token available");try{if(yield this.initializeFolderAndFile(t),!this.fileId)return console.log("File not found on Drive (fileId is null), will be created on next sync"),null;console.log("File found on Drive, checking metadata...",{fileId:this.fileId});let e=yield fetch(`https://www.googleapis.com/drive/v3/files/${this.fileId}?fields=modifiedTime`,{headers:{Authorization:`Bearer ${t}`}});if(e.status===401){let a=yield e.json().catch(()=>({}));throw console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(e.ok){let a=yield e.json(),d=new Date(a.modifiedTime);if(console.log("Drive file metadata:",{modifiedTime:d,localLastSynced:i}),i&&d<=i)return console.log("No changes on Drive since last sync, skipping download"),null;console.log("Drive file is newer, downloading...")}else{if(e.status===404)return console.log("File not found on Drive (404), will be created on next sync"),this.fileId=null,null;throw console.error("Unexpected response when checking file metadata:",e.status),new Error(`Failed to check file metadata: ${e.status}`)}console.log("Downloading file content...");let n=yield this.downloadFile(this.fileId,t);console.log("File content downloaded, parsing JSON...",{contentLength:n.length});let o=JSON.parse(n);console.log("JSON parsed successfully:",{hasNotes:!!o.notes,notesCount:o.notes?.length||0,hasCategories:!!o.categories,categoriesCount:o.categories?.length||0});let r=(o.notes||[]).map(a=>h(c({},a),{createdAt:new Date(a.createdAt),updatedAt:new Date(a.updatedAt),lastSyncedAt:a.lastSyncedAt?new Date(a.lastSyncedAt):void 0})),s=(o.categories||[]).map(a=>h(c({},a),{createdAt:new Date(a.createdAt),lastSyncedAt:a.lastSyncedAt?new Date(a.lastSyncedAt):void 0}));return{notes:r,categories:s}}catch(e){throw e?.status===401||e?.code===401||e?.message&&e.message.includes("401")||e?.error&&e.error.code===401?(console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error syncing from Google Drive:",e),e)}})}createFile(i,t){return l(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");let e=this.authService.currentUser()?.email||null,{fileName:n}=this.getFolderAndFileName(e),o={name:n,mimeType:"application/json",parents:[this.folderId]},r=new FormData;r.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json"})),r.append("file",i);let s=yield fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:r});if(s.status===401){let d=yield s.json().catch(()=>({}));throw console.error("Authentication error (401) creating file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!s.ok){let d=yield s.text();throw console.error("Create file error:",d),new Error("Failed to create file in Google Drive")}return(yield s.json()).id})}updateFile(i,t,e){return l(this,null,function*(){let n=yield fetch(`https://www.googleapis.com/upload/drive/v3/files/${i}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:t});if(n.status===401){let o=yield n.json().catch(()=>({}));throw console.error("Authentication error (401) updating file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!n.ok){let o=yield n.text();throw console.error("Update file error:",o),new Error("Failed to update file in Google Drive")}})}downloadFile(i,t){return l(this,null,function*(){let e=yield fetch(`https://www.googleapis.com/drive/v3/files/${i}?alt=media`,{headers:{Authorization:`Bearer ${t}`}});if(e.status===401){let n=yield e.json().catch(()=>({}));throw console.error("Authentication error (401) downloading file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!e.ok){let n=yield e.text();throw console.error("Download file error:",n),new Error("Failed to download file from Google Drive")}return yield e.text()})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})};export{m as a};
