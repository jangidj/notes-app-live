import{L as w,P as g,a as c,b as f,c as s,mb as m}from"./chunk-QQGFIXA2.js";var y=class p{authService=g(m);FOLDER_NAME="notes-app-data";FILE_NAME="notes-app-data.json";folderId=null;fileId=null;initializeFolderAndFile(r){return s(this,null,function*(){this.folderId||(this.folderId=yield this.findOrCreateFolder(r)),!this.fileId&&this.folderId&&(this.fileId=yield this.findOrCreateFile(r))})}findOrCreateFolder(r){return s(this,null,function*(){try{let e=yield(yield fetch(`https://www.googleapis.com/drive/v3/files?q=name='${this.FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,{headers:{Authorization:`Bearer ${r}`}})).json();if(e.files&&e.files.length>0)return e.files[0].id;let i=yield fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({name:this.FOLDER_NAME,mimeType:"application/vnd.google-apps.folder"})});if(!i.ok)throw new Error("Failed to create folder in Google Drive");return(yield i.json()).id}catch(t){throw console.error("Error finding/creating folder:",t),t}})}findOrCreateFile(r){return s(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");try{let e=yield(yield fetch(`https://www.googleapis.com/drive/v3/files?q=name='${this.FILE_NAME}' and '${this.folderId}' in parents and trashed=false`,{headers:{Authorization:`Bearer ${r}`}})).json();return e.files&&e.files.length>0?e.files[0].id:null}catch(t){return console.error("Error finding file:",t),null}})}syncToDrive(r,t){return s(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let e=this.authService.getAccessToken();if(!e)throw new Error("No access token available");let i=r.some(n=>n.needsSync),a=t.some(n=>n.needsSync);if(!i&&!a)return;yield this.initializeFolderAndFile(e);let l=new Date,d={notes:r.map(n=>f(c({},n),{lastSyncedAt:l.toISOString(),needsSync:!1})),categories:t.map(n=>f(c({},n),{lastSyncedAt:l.toISOString(),needsSync:!1})),lastSynced:l.toISOString()},o=JSON.stringify(d,null,2),h=new Blob([o],{type:"application/json"});try{this.fileId?yield this.updateFile(this.fileId,h,e):this.fileId=yield this.createFile(h,e)}catch(n){throw console.error("Error syncing to Google Drive:",n),n}})}syncFromDrive(r){return s(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let t=this.authService.getAccessToken();if(!t)throw new Error("No access token available");try{if(yield this.initializeFolderAndFile(t),!this.fileId)return null;let e=yield fetch(`https://www.googleapis.com/drive/v3/files/${this.fileId}?fields=modifiedTime`,{headers:{Authorization:`Bearer ${t}`}});if(e.ok){let o=yield e.json(),h=new Date(o.modifiedTime);if(r&&h<=r)return null}let i=yield this.downloadFile(this.fileId,t),a=JSON.parse(i),l=(a.notes||[]).map(o=>f(c({},o),{createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt),lastSyncedAt:o.lastSyncedAt?new Date(o.lastSyncedAt):void 0})),d=(a.categories||[]).map(o=>f(c({},o),{createdAt:new Date(o.createdAt),lastSyncedAt:o.lastSyncedAt?new Date(o.lastSyncedAt):void 0}));return{notes:l,categories:d}}catch(e){throw console.error("Error syncing from Google Drive:",e),e}})}createFile(r,t){return s(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");let e={name:this.FILE_NAME,mimeType:"application/json",parents:[this.folderId]},i=new FormData;i.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),i.append("file",r);let a=yield fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:i});if(!a.ok){let d=yield a.text();throw console.error("Create file error:",d),new Error("Failed to create file in Google Drive")}return(yield a.json()).id})}updateFile(r,t,e){return s(this,null,function*(){let i=yield fetch(`https://www.googleapis.com/upload/drive/v3/files/${r}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:t});if(!i.ok){let a=yield i.text();throw console.error("Update file error:",a),new Error("Failed to update file in Google Drive")}})}downloadFile(r,t){return s(this,null,function*(){let e=yield fetch(`https://www.googleapis.com/drive/v3/files/${r}?alt=media`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok){let i=yield e.text();throw console.error("Download file error:",i),new Error("Failed to download file from Google Drive")}return yield e.text()})}static \u0275fac=function(t){return new(t||p)};static \u0275prov=w({token:p,factory:p.\u0275fac,providedIn:"root"})};export{y as a};
