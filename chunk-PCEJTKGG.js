import{K as v,O as A,a as w,b as u,c as h,nb as F}from"./chunk-HVD5NXG4.js";var I=class m{authService=A(F);FOLDER_NAME_PREFIX="notes-app-data";FILE_NAME_PREFIX="notes-app-data";folderId=null;fileId=null;currentUserEmail=null;getFolderAndFileName(o){let i=o?o.replace(/[^a-zA-Z0-9]/g,"_"):"guest";return{folderName:`${this.FOLDER_NAME_PREFIX}-${i}`,fileName:`${this.FILE_NAME_PREFIX}-${i}.json`}}initializeFolderAndFile(o){return h(this,null,function*(){let i=this.authService.currentUser()?.email||null;if(this.currentUserEmail!==i&&(console.log("User changed, resetting folder/file IDs",{oldEmail:this.currentUserEmail,newEmail:i}),this.folderId=null,this.fileId=null,this.currentUserEmail=i),!this.folderId){console.log("Finding or creating folder...");try{this.folderId=yield this.findOrCreateFolder(o,i),console.log("Folder ID:",this.folderId)}catch(e){if(e?.message?.includes("401")||e?.status===401){console.log("401 error, refreshing token and retrying...");let r=yield this.authService.getAccessToken();if(r)this.folderId=yield this.findOrCreateFolder(r,i),console.log("Folder ID (after retry):",this.folderId);else throw e}else throw e}}if(!this.fileId&&this.folderId){console.log("Finding or creating file in folder...",{folderId:this.folderId});try{this.fileId=yield this.findOrCreateFile(o,i),console.log("File ID:",this.fileId)}catch(e){if(e?.message?.includes("401")||e?.status===401){console.log("401 error, refreshing token and retrying...");let r=yield this.authService.getAccessToken();if(r)this.fileId=yield this.findOrCreateFile(r,i),console.log("File ID (after retry):",this.fileId);else throw e}else throw e}}})}findOrCreateFolder(o,i){return h(this,null,function*(){try{let{folderName:e}=this.getFolderAndFileName(i),r=yield fetch(`https://www.googleapis.com/drive/v3/files?q=name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,{headers:{Authorization:`Bearer ${o}`}});if(r.status===401){let s=yield r.json().catch(()=>({}));throw console.error("Authentication error (401) searching for folder"),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!r.ok){let s=yield r.text();throw new Error(`Failed to search for folder: ${r.status} - ${s}`)}let l=yield r.json();if(l.files&&l.files.length>0)return l.files[0].id;let t=yield fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({name:e,mimeType:"application/vnd.google-apps.folder"})});if(t.status===401){let s=yield t.json().catch(()=>({}));throw console.error("Authentication error (401) creating folder"),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!t.ok){let s=yield t.text();throw console.error("Create folder error:",s),new Error(`Failed to create folder in Google Drive: ${t.status} - ${s}`)}return(yield t.json()).id}catch(e){throw e?.status===401||e?.code===401||e?.message&&e.message.includes("401")||e?.error&&e.error.code===401?(console.error("Authentication error (401) finding/creating folder, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error finding/creating folder:",e),e)}})}findOrCreateFile(o,i){return h(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");try{let{fileName:e}=this.getFolderAndFileName(i),r=e.replace(/'/g,"\\'"),l=`name='${r}' and '${this.folderId}' in parents and trashed=false`,t=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(l)}&fields=files(id,name)`;console.log("Searching for file:",{fileName:e,escapedFileName:r,folderId:this.folderId,searchQuery:l});let a=yield fetch(t,{headers:{Authorization:`Bearer ${o}`}});if(a.status===401)throw console.error("Authentication error (401) during file search"),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.");if(!a.ok){let d=yield a.text();throw console.error("Error searching for file:",a.status,d),new Error(`Failed to search for file: ${a.status}`)}let s=yield a.json();if(console.log("File search results:",{filesFound:s.files?.length||0,fileName:e,folderId:this.folderId}),s.files&&s.files.length>0){let d=s.files[0].id;return console.log("File found on Drive:",{fileId:d,fileName:s.files[0].name}),d}console.log("Exact match not found, trying alternative search...");let n=`'${this.folderId}' in parents and mimeType='application/json' and trashed=false`,f=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(n)}&fields=files(id,name,mimeType)`,p=yield fetch(f,{headers:{Authorization:`Bearer ${o}`}});if(p.ok){let d=yield p.json();if(console.log("Alternative search results:",{filesFound:d.files?.length||0,files:d.files?.map(c=>({id:c.id,name:c.name,mimeType:c.mimeType}))}),d.files&&d.files.length>0){let c=d.files.find(g=>g.name.includes(this.FILE_NAME_PREFIX)&&(g.name.endsWith(".json")||g.mimeType==="application/json"));if(c)return console.log("File found via alternative search:",{fileId:c.id,fileName:c.name}),c.id;console.warn("No matching file found. Files in folder:",d.files.map(g=>g.name))}}else{let d=yield p.text();console.error("Alternative search failed:",p.status,d)}console.log("Attempting to list all files in folder for debugging...");let S=`https://www.googleapis.com/drive/v3/files?q='${this.folderId}' in parents and trashed=false&fields=files(id,name,mimeType)`,y=yield fetch(S,{headers:{Authorization:`Bearer ${o}`}});if(y.ok){let d=yield y.json();console.log("All files in folder:",d.files?.map(c=>({id:c.id,name:c.name,mimeType:c.mimeType})))}return console.log("File not found in folder, will be created on next sync"),null}catch(e){throw e?.status===401||e?.code===401||e?.message&&e.message.includes("401")||e?.error&&e.error.code===401?(console.error("Authentication error (401) finding file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error finding file:",e),e)}})}syncToDrive(o,i){return h(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let e=yield this.authService.getAccessToken();if(!e)throw new Error("No access token available");let r=o.some(t=>t.needsSync),l=i.some(t=>t.needsSync);if(!(!r&&!l))try{yield this.initializeFolderAndFile(e);let t=new Date,a={notes:o.map(f=>u(w({},f),{lastSyncedAt:t.toISOString(),needsSync:!1})),categories:i.map(f=>u(w({},f),{lastSyncedAt:t.toISOString(),needsSync:!1})),lastSynced:t.toISOString()},s=JSON.stringify(a,null,2),n=new Blob([s],{type:"application/json"});this.fileId?yield this.updateFile(this.fileId,n,e):this.fileId=yield this.createFile(n,e)}catch(t){throw t?.status===401||t?.code===401||t?.message&&t.message.includes("401")||t?.error&&t.error.code===401?(console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error syncing to Google Drive:",t),t)}})}syncFromDrive(o,i=!1){return h(this,null,function*(){if(!this.authService.isSignedIn())throw new Error("User not signed in");let e=yield this.authService.getAccessToken();if(!e)throw new Error("No access token available");try{if(i&&(console.log("Force sync: Resetting fileId to force fresh search"),this.fileId=null),yield this.initializeFolderAndFile(e),!this.fileId)return console.log("File not found on Drive (fileId is null), will be created on next sync"),null;console.log("File found on Drive, checking metadata...",{fileId:this.fileId});let r=yield fetch(`https://www.googleapis.com/drive/v3/files/${this.fileId}?fields=modifiedTime`,{headers:{Authorization:`Bearer ${e}`}});if(r.status===401){let n=yield r.json().catch(()=>({}));throw console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(r.ok){let n=yield r.json(),f=new Date(n.modifiedTime);if(console.log("Drive file metadata:",{modifiedTime:f,localLastSynced:o}),o&&f<=o)return console.log("No changes on Drive since last sync, skipping download"),null;console.log("Drive file is newer, downloading...")}else{if(r.status===404)return console.log("File not found on Drive (404), will be created on next sync"),this.fileId=null,null;throw console.error("Unexpected response when checking file metadata:",r.status),new Error(`Failed to check file metadata: ${r.status}`)}console.log("Downloading file content...");let l=yield this.downloadFile(this.fileId,e);console.log("File content downloaded, parsing JSON...",{contentLength:l.length});let t=JSON.parse(l);console.log("JSON parsed successfully:",{hasNotes:!!t.notes,notesCount:t.notes?.length||0,hasCategories:!!t.categories,categoriesCount:t.categories?.length||0});let a=(t.notes||[]).map(n=>u(w({},n),{createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt),lastSyncedAt:n.lastSyncedAt?new Date(n.lastSyncedAt):void 0})),s=(t.categories||[]).map(n=>u(w({},n),{createdAt:new Date(n.createdAt),lastSyncedAt:n.lastSyncedAt?new Date(n.lastSyncedAt):void 0}));return{notes:a,categories:s}}catch(r){throw r?.status===401||r?.code===401||r?.message&&r.message.includes("401")||r?.error&&r.error.code===401?(console.error("Authentication error (401) during sync, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")):(console.error("Error syncing from Google Drive:",r),r)}})}createFile(o,i){return h(this,null,function*(){if(!this.folderId)throw new Error("Folder ID not initialized");let e=this.authService.currentUser()?.email||null,{fileName:r}=this.getFolderAndFileName(e),l={name:r,mimeType:"application/json",parents:[this.folderId]},t=new FormData;t.append("metadata",new Blob([JSON.stringify(l)],{type:"application/json"})),t.append("file",o);let a=yield fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${i}`},body:t});if(a.status===401){let n=yield a.json().catch(()=>({}));throw console.error("Authentication error (401) creating file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!a.ok){let n=yield a.text();throw console.error("Create file error:",n),new Error("Failed to create file in Google Drive")}return(yield a.json()).id})}updateFile(o,i,e){return h(this,null,function*(){let r=yield fetch(`https://www.googleapis.com/upload/drive/v3/files/${o}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:i});if(r.status===401){let l=yield r.json().catch(()=>({}));throw console.error("Authentication error (401) updating file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!r.ok){let l=yield r.text();throw console.error("Update file error:",l),new Error("Failed to update file in Google Drive")}})}downloadFile(o,i){return h(this,null,function*(){let e=yield fetch(`https://www.googleapis.com/drive/v3/files/${o}?alt=media`,{headers:{Authorization:`Bearer ${i}`}});if(e.status===401){let r=yield e.json().catch(()=>({}));throw console.error("Authentication error (401) downloading file, redirecting to login..."),yield this.authService.handleAuthError(),new Error("Session expired. Please sign in again.")}if(!e.ok){let r=yield e.text();throw console.error("Download file error:",r),new Error("Failed to download file from Google Drive")}return yield e.text()})}static \u0275fac=function(i){return new(i||m)};static \u0275prov=v({token:m,factory:m.\u0275fac,providedIn:"root"})};export{I as a};
